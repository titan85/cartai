<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CartAI ‚Äî Carta inteligente con IA</title>
  <meta name="theme-color" content="#0e1116">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="assets/icon-512.png" sizes="512x512">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <nav class="nav">
    <div class="brand">
      <img src="assets/icon-512.png" alt="CartAI">
      <span>CartAI</span>
    </div>
    <div class="meta">Carta inteligente ¬∑ PWA</div>
  </nav>

  <div class="container">
    <div class="notice">
      Edita la carta en Google Sheets (s√∫per f√°cil). Pon tu <b>SHEET_ID</b> y <b>SHEET_NAME</b> abajo.
    </div>

    <section id="carta"></section>

    <section class="footer">¬© CartAI ‚Äî Carta interactiva con IA</section>
  </div>

  <!-- FAB abre el chat embebido -->
  <button id="cartai-chat-fab" title="Habla con el asistente">üí¨</button>

  <!-- CHAT EMBEBIDO -->
  <div class="chat-overlay" id="chatOverlay" hidden>
    <div class="chat-panel">
      <div class="chat-header">
        <div class="chat-title">
          <img src="assets/icon-512.png" alt="CartAI"><span>Asistente CartAI</span>
        </div>
        <button class="chat-close" id="chatClose" aria-label="Cerrar">‚úï</button>
      </div>
      <div class="chat-messages" id="chatMessages" aria-live="polite"></div>
      <div class="chat-input">
        <input id="chatText" type="text" placeholder="Pregunta por al√©rgenos, medias raciones, precios, recomendaciones‚Ä¶" autocomplete="off" />
        <button id="chatSend" class="btn">Enviar</button>
      </div>
    </div>
  </div>

  <script>
    // ========= CONFIG =========
    // 1) Tu Google Sheet (dejar vac√≠o para usar carta.json local)
    const SHEET_ID = "";         // ej: '1AbCDEFghiJKL...'
    const SHEET_NAME = "Sheet1"; // nombre de pesta√±a
    // ==========================

    /* Utilidades */
    function euros(n){ try{ return (parseFloat(n)).toFixed(2).replace('.', ',') } catch(e){ return n } }
    const norm = s => (s||"").toString().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');

    /* Carga carta */
    async function fetchFromSheet(sheetId, sheetName='Sheet1'){
      const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
      const res = await fetch(url);
      const text = await res.text();
      const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}')+1));
      const rows = json.table.rows;
      const cols = json.table.cols.map(c => c.label);
      const items = rows.map(r => {
        const obj = {};
        r.c.forEach((cell, i) => obj[cols[i]] = cell ? cell.v : "");
        return obj;
      });
      return items.filter(i => (String(i.visible||'si').toLowerCase() === 'si'));
    }

    async function fetchLocal(){
      const res = await fetch('carta.json');
      const data = await res.json();
      const items = [];
      Object.entries(data).forEach(([cat, platos]) => {
        platos.forEach(p => items.push({
          categoria: cat, nombre: p.nombre, precio: p.precio,
          alergenos: (p.alergenos||[]).join(', '), descripcion: p.descripcion, visible: 'si'
        }));
      });
      return items;
    }

    function groupBy(arr, key){
      return arr.reduce((acc,it)=>{const k=it[key]||'Otros'; (acc[k]=acc[k]||[]).push(it); return acc},{});
    }

    function render(items){
      const mount = document.getElementById('carta');
      mount.innerHTML = "";
      const byCat = groupBy(items, 'categoria');

      Object.keys(byCat).forEach(cat => {
        const section = document.createElement('section');
        section.className = 'section';

        const header = document.createElement('h3');
        header.textContent = cat;
        section.appendChild(header);

        const grid = document.createElement('div');
        grid.className = 'grid';

        byCat[cat].forEach(p => {
          const card = document.createElement('div');
          card.className = 'item';
          const alerg = (p.alergenos||"").split(',').map(s=>s.trim()).filter(Boolean);

          card.innerHTML = `
            <h4>${p.nombre}</h4>
            <p>${p.descripcion||''}</p>
            <div class="badges">${alerg.length ? alerg.map(a=>`<span class="badge">${a}</span>`).join(' ') : '<span class="badge">Sin al√©rgenos</span>'}</div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
              <div class="price">${euros(p.precio)}‚Ç¨</div>
              <button class="btn consult-btn" data-name="${p.nombre}">Consultar</button>
            </div>
          `;
          grid.appendChild(card);
        });

        section.appendChild(grid);
        mount.appendChild(section);
      });

      // ‚ÄúConsultar‚Äù abre chat pre-rellenado
      mount.querySelectorAll('.consult-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const name = e.currentTarget.dataset.name;
          openChat();
          addUserMsg(`Info de "${name}"`);
          handleQuestion(`info ${name}`);
        });
      });
    }

    // ========= CHAT EMBEBIDO (motor smart retrieval sin LLM) =========
    let MENU = []; // items: {categoria, nombre, precio, alergenos, descripcion}
    const elOverlay = document.getElementById('chatOverlay');
    const elMessages = document.getElementById('chatMessages');
    const elText = document.getElementById('chatText');

    function openChat(){
      elOverlay.hidden = false;
      setTimeout(()=>elText.focus(), 50);
      if (!elMessages.dataset.greeted){
        addBotMsg("Hola üëã Soy el asistente de CartAI. Pregunta por <b>al√©rgenos</b>, <b>medias raciones</b>, <b>precios</b> o p√≠deme <b>recomendaciones</b> (carne, pescado, sin gluten, sin l√°cteos‚Ä¶).");
        elMessages.dataset.greeted = "1";
      }
    }
    function closeChat(){ elOverlay.hidden = true; }
    document.getElementById('cartai-chat-fab').addEventListener('click', openChat);
    document.getElementById('chatClose').addEventListener('click', closeChat);
    elOverlay.addEventListener('click', (e)=>{ if(e.target===elOverlay) closeChat(); });

    function addMsg(html, who='user'){
      const wrap = document.createElement('div');
      wrap.className = 'chat-msg ' + who;
      wrap.innerHTML = html;
      elMessages.appendChild(wrap);
      elMessages.scrollTop = elMessages.scrollHeight;
    }
    const addUserMsg = (t)=> addMsg(`<div class="bubble">${t}</div>`,'user');
    const addBotMsg  = (t)=> addMsg(`<div class="bubble">${t}</div>`,'bot');

    // Indexaci√≥n ligera por nombre y al√©rgenos
    function findDish(query){
      const q = norm(query);
      // busca por nombre
      let best = MENU.filter(i => norm(i.nombre).includes(q));
      if (best.length) return best;
      // busca por categor√≠a
      best = MENU.filter(i => norm(i.categoria).includes(q));
      if (best.length) return best;
      return [];
    }
    function parseAllergens(s){ return (s||"").split(',').map(x=>norm(x.trim())).filter(Boolean); }

    function handleQuestion(text){
      const q = norm(text);

      // Detectores b√°sicos
      const askAllergens = /(alergen|gluten|lacte|huevo|soja|fruto seco|cacahuete|sesamo|molusc)/.test(q);
      const askHalf = /(media racion|media|mitad|1\/2)/.test(q);
      const askPrice = /(precio|cuesta|vale)/.test(q);
      const askRecommend = /(recomienda|recomendaci|suger|que pedir|que me recomiendas)/.test(q);

      // Si el usuario menciona un plato concreto
      const dishMatch = q.match(/info (.+)$|de (.+)$|sobre (.+)$|croqueta|tortilla|calamar|burger|bowl|gyoza|hummus|coulant|ipa|kombucha/);
      let dishes = [];
      if (dishMatch) {
        const raw = (dishMatch[1]||dishMatch[2]||dishMatch[3]||"").trim();
        dishes = raw ? findDish(raw) : [];
        if (!dishes.length && raw) {
          // aproximaci√≥n: busca por tokens
          const tokens = raw.split(/\s+/).map(norm);
          dishes = MENU.filter(d => tokens.some(t => norm(d.nombre).includes(t)));
        }
      }

      // Respuestas
      if (askRecommend && !dishes.length){
        return addBotMsg(recommendFromMenu(q));
      }

      if (dishes.length){
        const d = dishes[0];
        const alergs = parseAllergens(d.alergenos);
        const alergos = alergs.length ? d.alergenos : "Sin al√©rgenos declarados";
        let out = `<b>${d.nombre}</b> ‚Äî ${euros(d.precio)}‚Ç¨<br>${d.descripcion||''}<br><small><b>Al√©rgenos:</b> ${alergos}</small>`;

        if (askAllergens) {
          return addBotMsg(out);
        }
        if (askPrice) {
          return addBotMsg(`<b>${d.nombre}</b> cuesta <b>${euros(d.precio)}‚Ç¨</b>. ${d.descripcion?('<br>'+d.descripcion):''}`);
        }
        if (askHalf) {
          return addBotMsg(`La <b>media raci√≥n</b> depende del local. ¬øQuieres que avise al camarero? Habitualmente, si se ofrece, es un <b>~60% del precio</b>.`);
        }
        // por defecto: ficha del plato
        return addBotMsg(out);
      }

      // Pregunta general sobre al√©rgenos (sin plato)
      if (askAllergens && !dishes.length){
        const allergen = (q.match(/gluten|lacte|huevo|soja|sesamo|cacahuete|molusc|fruto seco/)||[])[0] || '';
        if (allergen){
          const matches = MENU.filter(d => parseAllergens(d.alergenos).some(a => a.includes(allergen.startsWith('lacte')?'lact':'gluten'.slice(0,6))) );
          if (matches.length){
            const list = matches.slice(0,8).map(d=>`‚Ä¢ ${d.nombre} (${euros(d.precio)}‚Ç¨)`).join('<br>');
            return addBotMsg(`Platos que <b>contienen ${allergen}</b>:<br>${list}`);
          } else {
            return addBotMsg(`No veo platos con <b>${allergen}</b> en la carta actual.`);
          }
        }
        return addBotMsg(`Dime el al√©rgeno (p.ej. ‚Äúsin gluten‚Äù, ‚Äúcontiene huevo‚Äù) o menciona un plato concreto.`);
      }

      // Sin plato detectado: intenta ayudar
      if (askPrice) return addBotMsg(`Dime el nombre del plato para decirte el precio exacto.`);
      if (askHalf)  return addBotMsg(`Dime el plato y te digo si suele ofrecerse en media raci√≥n o te contacto con el camarero.`);
      if (askRecommend) return addBotMsg(recommendFromMenu(q));

      // Fallback
      addBotMsg(`Puedo ayudarte con <b>al√©rgenos</b>, <b>precios</b>, <b>medias raciones</b> y <b>recomendaciones</b>. Prueba: ‚Äú¬øLas gyozas llevan gluten?‚Äù, ‚ÄúPrecio de la burger‚Äù, ‚ÄúSin lactosa‚Äù.`);
    }

    function recommendFromMenu(q){
      const wantNo = (kw) => /(sin |no )/.test(q) && new RegExp(kw).test(q);
      const noGluten = wantNo('gluten');
      const noLact  = wantNo('lacte');
      const tokens = MENU.map(d => ({...d, score: 0}));

      tokens.forEach(t=>{
        const al = norm(t.alergenos);
        if (noGluten && al.includes('gluten')) t.score -= 5;
        if (noLact && al.includes('lact')) t.score -= 5;
        if (/carne|burger|ternera/.test(q) && /burger|carne|ternera/i.test(t.nombre)) t.score += 3;
        if (/pescado|mar|calamar|romana/.test(q) && /calamar|mar/i.test(norm(t.nombre))) t.score += 3;
        if (/veg|vegetar/.test(q) && /(hummus|ensalada|veg)/i.test(norm(t.nombre))) t.score += 3;
        if (/dulce|postre|tarta|coulant/.test(q) && /(coulant|tarta|postre)/i.test(norm(t.nombre))) t.score += 3;
        // base por precio medio
        const pr = parseFloat(t.precio||0);
        if (!isNaN(pr) && pr <= 8) t.score += 1;
      });

      const top = tokens.sort((a,b)=>b.score-a.score).slice(0,3);
      if (!top.length) return `¬øPrefieres carne, pescado, vegetariano o dulce? Te sugiero en base a eso.`;
      return `Te puedo recomendar:<br>` + top.map(t=>`‚Ä¢ <b>${t.nombre}</b> (${euros(t.precio)}‚Ç¨) ‚Äî ${t.descripcion||''}`).join('<br>');
    }

    // Eventos chat
    document.getElementById('chatSend').addEventListener('click', ()=>{
      const t = elText.value.trim();
      if(!t) return;
      addUserMsg(t);
      elText.value = '';
      handleQuestion(t);
    });
    elText.addEventListener('keydown', (e)=>{
      if(e.key==='Enter'){ e.preventDefault(); document.getElementById('chatSend').click(); }
    });

    // Init
    async function init(){
      try{
        const items = SHEET_ID ? await fetchFromSheet(SHEET_ID, SHEET_NAME) : await fetchLocal();
        MENU = items;
        render(items);
      }catch(e){
        console.error("Fallo Google Sheets, usando carta.json", e);
        const items = await fetchLocal();
        MENU = items;
        render(items);
      }
    }

    // PWA
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => navigator.serviceWorker.register('service-worker.js'));
    }

    init();
  </script>
</body>
</html>
